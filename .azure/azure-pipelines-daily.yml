# DO NOT EDIT azure-pipelines-daily.yml.  Edit azure-pipelines-daily.yml.m4 and defs.m4 instead.

trigger: none
pr: none

schedules:
  # 8am UTC is midnight PST.
  - cron: '0 8 * * *'
    displayName: Daily midnight build
    branches:
      include:
        - master

variables:
  system.debug: true

jobs:

  # The dependsOn clauses are:
  #  * Everything depends on the canary jobs (the main jdk25 jobs), except those jobs themselves.
  #  * Any other *_jdkNN job depends on the corresponding *_jdk25 job.

  - job: canary_jobs
    dependsOn:
      - junit_jdk25
      - nonjunit_jdk25
      - inference_part1_jdk25
      - inference_part2_jdk25
      - typecheck_part1_jdk25
      - typecheck_part2_jdk25
    pool:
      vmImage: 'ubuntu-latest'
    steps:
      - bash: true
        displayName: canary_jobs

  - job: junit_jdk11
    dependsOn:
      - canary_jobs
      - junit_jdk25
    pool:
      vmImage: 'ubuntu-latest'
    container: mdernst/cf-ubuntu-jdk11:latest
    timeoutInMinutes: 70
    steps:
      - checkout: self
        fetchDepth: 25
      - bash: export ORG_GRADLE_PROJECT_jdkTestVersion=11 && ./checker/bin-devel/test-cftests-junit.sh
        displayName: test-cftests-junit.sh
  - job: junit_jdk17
    dependsOn:
      - canary_jobs
      - junit_jdk25
    pool:
      vmImage: 'ubuntu-latest'
    container: mdernst/cf-ubuntu-jdk17:latest
    timeoutInMinutes: 70
    steps:
      - checkout: self
        fetchDepth: 25
      - bash: export ORG_GRADLE_PROJECT_jdkTestVersion=17 && ./checker/bin-devel/test-cftests-junit.sh
        displayName: test-cftests-junit.sh
  - job: junit_jdk21
    dependsOn:
      - canary_jobs
      - junit_jdk25
    pool:
      vmImage: 'ubuntu-latest'
    container: mdernst/cf-ubuntu-jdk21:latest
    timeoutInMinutes: 70
    steps:
      - checkout: self
        fetchDepth: 25
      - bash: export ORG_GRADLE_PROJECT_jdkTestVersion=21 && ./checker/bin-devel/test-cftests-junit.sh
        displayName: test-cftests-junit.sh
  - job: junit_jdk25
    pool:
      vmImage: 'ubuntu-latest'
    container: mdernst/cf-ubuntu-jdk25:latest
    timeoutInMinutes: 70
    steps:
      - checkout: self
        fetchDepth: 25
      - bash: export ORG_GRADLE_PROJECT_jdkTestVersion=25 && ./checker/bin-devel/test-cftests-junit.sh
        displayName: test-cftests-junit.sh

  - job: nonjunit_jdk11
    dependsOn:
      - canary_jobs
      - nonjunit_jdk25
    pool:
      vmImage: 'ubuntu-latest'
    container: mdernst/cf-ubuntu-jdk11:latest
    steps:
      - checkout: self
        fetchDepth: 25
      - bash: export ORG_GRADLE_PROJECT_jdkTestVersion=11 && ./checker/bin-devel/test-cftests-nonjunit.sh
        displayName: test-cftests-nonjunit.sh
  - job: nonjunit_jdk17
    dependsOn:
      - canary_jobs
      - nonjunit_jdk25
    pool:
      vmImage: 'ubuntu-latest'
    container: mdernst/cf-ubuntu-jdk17:latest
    steps:
      - checkout: self
        fetchDepth: 25
      - bash: export ORG_GRADLE_PROJECT_jdkTestVersion=17 && ./checker/bin-devel/test-cftests-nonjunit.sh
        displayName: test-cftests-nonjunit.sh
  - job: nonjunit_jdk21
    dependsOn:
      - canary_jobs
      - nonjunit_jdk25
    pool:
      vmImage: 'ubuntu-latest'
    container: mdernst/cf-ubuntu-jdk21:latest
    steps:
      - checkout: self
        fetchDepth: 25
      - bash: export ORG_GRADLE_PROJECT_jdkTestVersion=21 && ./checker/bin-devel/test-cftests-nonjunit.sh
        displayName: test-cftests-nonjunit.sh
  - job: nonjunit_jdk25
    pool:
      vmImage: 'ubuntu-latest'
    container: mdernst/cf-ubuntu-jdk25:latest
    steps:
      - checkout: self
        fetchDepth: 25
      - bash: export ORG_GRADLE_PROJECT_jdkTestVersion=25 && ./checker/bin-devel/test-cftests-nonjunit.sh
        displayName: test-cftests-nonjunit.sh

  # Sometimes one of the invocations of wpi-many in `./gradlew wpiManyTest`
  # takes much longer to complete than normal, and this Azure job times out.
  # When there is a timeout, one cannot examine wpi or wpi-many logs.
  # So use a timeout of 90 minutes, and hope that is enough.
  # Inference on JDK 11 seems to be broken because do-like-javac doesn't pass --release.
  # inference_job(11)
  - job: inference_jdk17
    dependsOn:
      - canary_jobs
      - inference_part1_jdk25
      - inference_part2_jdk25
    pool:
      vmImage: 'ubuntu-latest'
    container: mdernst/cf-ubuntu-jdk17:latest
    timeoutInMinutes: 90
    steps:
      - checkout: self
        fetchDepth: 25
      - bash: export ORG_GRADLE_PROJECT_jdkTestVersion=17 && ./checker/bin-devel/test-cftests-inference.sh
        displayName: test-cftests-inference.sh

  - job: inference_jdk21
    dependsOn:
      - canary_jobs
      - inference_part1_jdk25
      - inference_part2_jdk25
    pool:
      vmImage: 'ubuntu-latest'
    container: mdernst/cf-ubuntu-jdk21:latest
    timeoutInMinutes: 90
    steps:
      - checkout: self
        fetchDepth: 25
      - bash: export ORG_GRADLE_PROJECT_jdkTestVersion=21 && ./checker/bin-devel/test-cftests-inference.sh
        displayName: test-cftests-inference.sh

  # Split into part1 and part2 only for the inference job that "canary_jobs" depends on.
  - job: inference_part1_jdk25
    pool:
      vmImage: 'ubuntu-latest'
    container: mdernst/cf-ubuntu-jdk25:latest
    timeoutInMinutes: 90
    steps:
      - checkout: self
        fetchDepth: 25
      - bash: export ORG_GRADLE_PROJECT_jdkTestVersion=25 && ./checker/bin-devel/test-cftests-inference-part1.sh
        displayName: test-cftests-inference-part1.sh
  - job: inference_part2_jdk25
    pool:
      vmImage: 'ubuntu-latest'
    container: mdernst/cf-ubuntu-jdk25:latest
    timeoutInMinutes: 90
    steps:
      - checkout: self
        fetchDepth: 25
      - bash: export ORG_GRADLE_PROJECT_jdkTestVersion=25 && ./checker/bin-devel/test-cftests-inference-part2.sh
        displayName: test-cftests-inference-part2.sh

  # Do not run misc_job daily, because it does diffs that assume it is running in
  # a pull request.

  - job: typecheck_jdk11
    dependsOn:
      - canary_jobs
      - typecheck_part1_jdk25
      - typecheck_part2_jdk25
    pool:
      vmImage: 'ubuntu-latest'
    container: mdernst/cf-ubuntu-jdk11:latest
    steps:
      - checkout: self
        fetchDepth: 1000
      - bash: export ORG_GRADLE_PROJECT_jdkTestVersion=11 && ./checker/bin-devel/test-typecheck.sh
        displayName: test-typecheck.sh
  - job: typecheck_jdk17
    dependsOn:
      - canary_jobs
      - typecheck_part1_jdk25
      - typecheck_part2_jdk25
    pool:
      vmImage: 'ubuntu-latest'
    container: mdernst/cf-ubuntu-jdk17:latest
    steps:
      - checkout: self
        fetchDepth: 1000
      - bash: export ORG_GRADLE_PROJECT_jdkTestVersion=17 && ./checker/bin-devel/test-typecheck.sh
        displayName: test-typecheck.sh
  - job: typecheck_jdk21
    dependsOn:
      - canary_jobs
      - typecheck_part1_jdk25
      - typecheck_part2_jdk25
    pool:
      vmImage: 'ubuntu-latest'
    container: mdernst/cf-ubuntu-jdk21:latest
    steps:
      - checkout: self
        fetchDepth: 1000
      - bash: export ORG_GRADLE_PROJECT_jdkTestVersion=21 && ./checker/bin-devel/test-typecheck.sh
        displayName: test-typecheck.sh
  - job: typecheck_part1_jdk25
    pool:
      vmImage: 'ubuntu-latest'
    container: mdernst/cf-ubuntu-jdk25:latest
    steps:
      - checkout: self
        fetchDepth: 1000
      - bash: export ORG_GRADLE_PROJECT_jdkTestVersion=25 && ./checker/bin-devel/test-typecheck-part1.sh
        displayName: test-typecheck-part1.sh
  - job: typecheck_part2_jdk25
    pool:
      vmImage: 'ubuntu-latest'
    container: mdernst/cf-ubuntu-jdk25:latest
    steps:
      - checkout: self
        fetchDepth: 1000
      - bash: export ORG_GRADLE_PROJECT_jdkTestVersion=25 && ./checker/bin-devel/test-typecheck-part2.sh
        displayName: test-typecheck-part2.sh

  - job: daikon_part1_jdk11
    dependsOn:
      - canary_jobs
      - daikon_part1_jdk25
    pool:
      vmImage: 'ubuntu-latest'
    container: mdernst/cf-ubuntu-jdk11:latest
    timeoutInMinutes: 70
    steps:
      - checkout: self
        fetchDepth: 25
      - bash: export ORG_GRADLE_PROJECT_jdkTestVersion=11 && ./checker/bin-devel/test-daikon-part1.sh
        displayName: test-daikon-part1.sh
  - job: daikon_part2_jdk11
    dependsOn:
      - canary_jobs
    pool:
      vmImage: 'ubuntu-latest'
    container: mdernst/cf-ubuntu-jdk11:latest
    timeoutInMinutes: 80
    steps:
      - checkout: self
        fetchDepth: 25
      - bash: export ORG_GRADLE_PROJECT_jdkTestVersion=11 && ./checker/bin-devel/test-daikon-part2.sh
        displayName: test-daikon-part2.sh
  - job: daikon_part3_jdk11
    dependsOn:
      - canary_jobs
    pool:
      vmImage: 'ubuntu-latest'
    container: mdernst/cf-ubuntu-jdk11:latest
    timeoutInMinutes: 80
    steps:
      - checkout: self
        fetchDepth: 25
      - bash: export ORG_GRADLE_PROJECT_jdkTestVersion=11 && ./checker/bin-devel/test-daikon-part3.sh
        displayName: test-daikon-part3.sh
  - job: daikon_part1_jdk17
    dependsOn:
      - canary_jobs
      - daikon_part1_jdk25
    pool:
      vmImage: 'ubuntu-latest'
    container: mdernst/cf-ubuntu-jdk17:latest
    timeoutInMinutes: 70
    steps:
      - checkout: self
        fetchDepth: 25
      - bash: export ORG_GRADLE_PROJECT_jdkTestVersion=17 && ./checker/bin-devel/test-daikon-part1.sh
        displayName: test-daikon-part1.sh
  - job: daikon_part2_jdk17
    dependsOn:
      - canary_jobs
    pool:
      vmImage: 'ubuntu-latest'
    container: mdernst/cf-ubuntu-jdk17:latest
    timeoutInMinutes: 80
    steps:
      - checkout: self
        fetchDepth: 25
      - bash: export ORG_GRADLE_PROJECT_jdkTestVersion=17 && ./checker/bin-devel/test-daikon-part2.sh
        displayName: test-daikon-part2.sh
  - job: daikon_part3_jdk17
    dependsOn:
      - canary_jobs
    pool:
      vmImage: 'ubuntu-latest'
    container: mdernst/cf-ubuntu-jdk17:latest
    timeoutInMinutes: 80
    steps:
      - checkout: self
        fetchDepth: 25
      - bash: export ORG_GRADLE_PROJECT_jdkTestVersion=17 && ./checker/bin-devel/test-daikon-part3.sh
        displayName: test-daikon-part3.sh
  - job: daikon_part1_jdk21
    dependsOn:
      - canary_jobs
      - daikon_part1_jdk25
    pool:
      vmImage: 'ubuntu-latest'
    container: mdernst/cf-ubuntu-jdk21:latest
    timeoutInMinutes: 70
    steps:
      - checkout: self
        fetchDepth: 25
      - bash: export ORG_GRADLE_PROJECT_jdkTestVersion=21 && ./checker/bin-devel/test-daikon-part1.sh
        displayName: test-daikon-part1.sh
  - job: daikon_part2_jdk21
    dependsOn:
      - canary_jobs
    pool:
      vmImage: 'ubuntu-latest'
    container: mdernst/cf-ubuntu-jdk21:latest
    timeoutInMinutes: 80
    steps:
      - checkout: self
        fetchDepth: 25
      - bash: export ORG_GRADLE_PROJECT_jdkTestVersion=21 && ./checker/bin-devel/test-daikon-part2.sh
        displayName: test-daikon-part2.sh
  - job: daikon_part3_jdk21
    dependsOn:
      - canary_jobs
    pool:
      vmImage: 'ubuntu-latest'
    container: mdernst/cf-ubuntu-jdk21:latest
    timeoutInMinutes: 80
    steps:
      - checkout: self
        fetchDepth: 25
      - bash: export ORG_GRADLE_PROJECT_jdkTestVersion=21 && ./checker/bin-devel/test-daikon-part3.sh
        displayName: test-daikon-part3.sh
  - job: daikon_part1_jdk25
    dependsOn:
      - canary_jobs
    pool:
      vmImage: 'ubuntu-latest'
    container: mdernst/cf-ubuntu-jdk25:latest
    timeoutInMinutes: 70
    steps:
      - checkout: self
        fetchDepth: 25
      - bash: export ORG_GRADLE_PROJECT_jdkTestVersion=25 && ./checker/bin-devel/test-daikon-part1.sh
        displayName: test-daikon-part1.sh
  - job: daikon_part2_jdk25
    dependsOn:
      - canary_jobs
    pool:
      vmImage: 'ubuntu-latest'
    container: mdernst/cf-ubuntu-jdk25:latest
    timeoutInMinutes: 80
    steps:
      - checkout: self
        fetchDepth: 25
      - bash: export ORG_GRADLE_PROJECT_jdkTestVersion=25 && ./checker/bin-devel/test-daikon-part2.sh
        displayName: test-daikon-part2.sh
  - job: daikon_part3_jdk25
    dependsOn:
      - canary_jobs
    pool:
      vmImage: 'ubuntu-latest'
    container: mdernst/cf-ubuntu-jdk25:latest
    timeoutInMinutes: 80
    steps:
      - checkout: self
        fetchDepth: 25
      - bash: export ORG_GRADLE_PROJECT_jdkTestVersion=25 && ./checker/bin-devel/test-daikon-part3.sh
        displayName: test-daikon-part3.sh

  ## I think the guava_jdk11 job is failing due to Error Prone not supporting JDK 11.
  - job: guava_jdk17
    dependsOn:
      - canary_jobs
      - guava_jdk25
    pool:
      vmImage: 'ubuntu-latest'
    container: mdernst/cf-ubuntu-jdk17:latest
    timeoutInMinutes: 70
    steps:
      - checkout: self
        fetchDepth: 25
      - bash: export ORG_GRADLE_PROJECT_jdkTestVersion=17 && ./checker/bin-devel/test-guava.sh
        displayName: test-guava.sh
  - job: guava_jdk21
    dependsOn:
      - canary_jobs
      - guava_jdk25
    pool:
      vmImage: 'ubuntu-latest'
    container: mdernst/cf-ubuntu-jdk21:latest
    timeoutInMinutes: 70
    steps:
      - checkout: self
        fetchDepth: 25
      - bash: export ORG_GRADLE_PROJECT_jdkTestVersion=21 && ./checker/bin-devel/test-guava.sh
        displayName: test-guava.sh
  - job: guava_jdk25
    dependsOn:
      - canary_jobs
    pool:
      vmImage: 'ubuntu-latest'
    container: mdernst/cf-ubuntu-jdk25:latest
    timeoutInMinutes: 70
    steps:
      - checkout: self
        fetchDepth: 25
      - bash: export ORG_GRADLE_PROJECT_jdkTestVersion=25 && ./checker/bin-devel/test-guava.sh
        displayName: test-guava.sh

  - job: plume_lib_jdk11
    dependsOn:
      - canary_jobs
      - plume_lib_jdk25
    pool:
      vmImage: 'ubuntu-latest'
    container: mdernst/cf-ubuntu-jdk11:latest
    steps:
      - checkout: self
        fetchDepth: 25
      - bash: export ORG_GRADLE_PROJECT_jdkTestVersion=11 && ./checker/bin-devel/test-plume-lib.sh
        displayName: test-plume-lib.sh
  - job: plume_lib_jdk17
    dependsOn:
      - canary_jobs
      - plume_lib_jdk25
    pool:
      vmImage: 'ubuntu-latest'
    container: mdernst/cf-ubuntu-jdk17:latest
    steps:
      - checkout: self
        fetchDepth: 25
      - bash: export ORG_GRADLE_PROJECT_jdkTestVersion=17 && ./checker/bin-devel/test-plume-lib.sh
        displayName: test-plume-lib.sh
  - job: plume_lib_jdk21
    dependsOn:
      - canary_jobs
      - plume_lib_jdk25
    pool:
      vmImage: 'ubuntu-latest'
    container: mdernst/cf-ubuntu-jdk21:latest
    steps:
      - checkout: self
        fetchDepth: 25
      - bash: export ORG_GRADLE_PROJECT_jdkTestVersion=21 && ./checker/bin-devel/test-plume-lib.sh
        displayName: test-plume-lib.sh
  - job: plume_lib_jdk25
    dependsOn:
      - canary_jobs
    pool:
      vmImage: 'ubuntu-latest'
    container: mdernst/cf-ubuntu-jdk25:latest
    steps:
      - checkout: self
        fetchDepth: 25
      - bash: export ORG_GRADLE_PROJECT_jdkTestVersion=25 && ./checker/bin-devel/test-plume-lib.sh
        displayName: test-plume-lib.sh
