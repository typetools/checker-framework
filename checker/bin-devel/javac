#!/bin/sh

#
# This file simply redirects all passed arguments
# to org.checkerframework.framework.util.CheckerDevelMain
#
# This script loads the .class files found in the
# build directory before it uses any jar files.
# Thus, a user can just do
#  ./gradlew compileJava
# to debug changes rather than creating .jar files with "./gradlew assemble".

# When editing, keep this file in sync with ./javac-debug and ../bin/javac .

mydir="$(dirname "$0")"
case $(uname -s) in
    CYGWIN*)
      mydir=$(cygpath -m "$mydir")
      ;;
esac

binaryDir="${mydir}"/../dist

javacJar=${binaryDir}/javac.jar

cfDir="${mydir}"/../..
annoToolsDir="${cfDir}"/../annotation-tools
stubparserDir="${cfDir}"/../stubparser
classes="build/classes/java/main"
testclasses="build/classes/java/test"
resources="build/resources/main"

buildDirs="${cfDir}"/dataflow/"${classes}":"${cfDir}"/javacutil/"${classes}":"${cfDir}"/framework/"${classes}":"${cfDir}"/framework/"${testclasses}":"${cfDir}"/framework/"${resources}":"${cfDir}"/checker/"${classes}":"${cfDir}"/checker/"${resources}":"${cfDir}"/checker-qual/"${classes}":"${stubparserDir}"/javaparser-core/stubparser.jar:"${annoToolsDir}"/annotation-file-utilities/"${classes}":$( (cd "${cfDir}" && ./gradlew -q :checker:printClasspath) )

## Preserve quoting and spaces in arguments, which would otherwise be lost
## due to being passed through the shell twice.
# Unset IFS and use newline as arg separator to preserve spaces in args.
# shellcheck disable=SC2034
DUALCASE=1  # for MKS: make case statement case-sensitive (6709498)
saveIFS="$IFS"
nl='
'
for i in "$@" ; do
   IFS=
   # shellcheck disable=SC2027
   case $i in
     "-Xmn"*) jvmargs=$jvmargs$nl"'"$i"'" ;;
     "-Xms"*) jvmargs=$jvmargs$nl"'"$i"'" ;;
     "-Xmx"*) jvmargs=$jvmargs$nl"'"$i"'" ;;
     *)       args=$args$nl"'"$i"'" ;;
   esac
   IFS="$saveIFS"
done

# TODO: We really only want the qualifiers on the CP, but there is no
# easy way to determine them here. ../bin/javac can use
# checker-qual.jar, but it might not exist yet.
# Set .cp to all build directories for now.

# Add the following option for verbose output:
#     "-DCheckerDevelMain.verbose=TRUE" \

# shellcheck disable=SC2086
eval "java" \
     ${jvmargs} \
     "-ea " \
     "-DCheckerDevelMain.cp=${buildDirs} " \
     "-DCheckerDevelMain.pp=${buildDirs} " \
     "-DCheckerDevelMain.runtime.cp=${javacJar} " \
     "-DCheckerDevelMain.binary=${binaryDir} " \
     "-classpath ${buildDirs} " \
     "org.checkerframework.framework.util.CheckerDevelMain" \
     ${args}
