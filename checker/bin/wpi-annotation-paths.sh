#!/bin/sh

# Given the name of a directory containing the results produced by an
# invocation of wpi-many.sh and a filename, output the paths to the .ajava
# files produced by whole-program inference to a .txt file with the given name.

# Usage:
#   wpi-annotation-paths TARGETDIR RESULT_FILE_NAME

TARGETDIR="$1"
RESULT_FILE_NAME="$2"

if [ "$#" -ne 2 ]; then
  echo "Usage: $(basename "$0") TARGETDIR RESULT_FILE_NAME" >&2
  exit 1
fi

for wpi_log_file in "$TARGETDIR"/*-wpi-stdout.log;
do
  echo "Log file: $wpi_log_file" >> "$RESULT_FILE_NAME"

  # The latest match from grep should be reported, as the latest match
  # in the file corresponds to the final (and most precise) set of annotations
  # generated by whole-program inference.
  FULL_AJAVA_MATCH=$(grep -oE 'Aajava=/[^ ]+' "$wpi_log_file" | tail -1 | tr -d "'")
  AJAVA_PATH=""
  if [ -z "$FULL_AJAVA_MATCH" ]; then
    AJAVA_PATH="No .ajava files generated"
  else
    AJAVA_PATH=$(echo "$FULL_AJAVA_MATCH" | cut -d "=" -f 2 | tr -d "'" )
  fi

  echo "Annotated file(s): $AJAVA_PATH" >> "$RESULT_FILE_NAME"
done
